---
title: "Yujia_Cluster"
author: "Yujia_Wang"
date: "11/14/2021"
output: html_document
---

```{r,message=FALSE}
library(ggplot2)
library(tidyverse)
library(dplyr)
library(tidyr)

library(TSdist) # open XQuartz
#https://cran.r-project.org/web/packages/TSdist/TSdist.pdf
#https://journal.r-project.org/archive/2016/RJ-2016-058/RJ-2016-058.pdf

library(lubridate)
library(tibble)
library(factoextra)
library(rbenchmark)
```

```{r,message=FALSE}
source("Input_Zeros.R") # input the data

efficiency <- actual_daily$sum / execution_daily$sum
efficiency <- as.data.frame(efficiency)

efficiency_daily <- data.frame(actual_daily$NEWID,actual_daily$date,efficiency)
colnames(efficiency_daily) <- c("NEWID","date","sum")
efficiency_daily <- efficiency_daily %>% 
  mutate(sum = replace(sum, sum == "NaN", 0))
```

```{r}
#DTW method
dtw_function <- function(x,begin_date,end_date){
  # change date column into date format
  x$date <-as.Date(x$date)
  # select the time range
  x <- x[x$date >=begin_date & x$date<= end_date,]
  # select the number of warehouse from 1 to 320 ????
  # x <- x[x$NEWID<=warehouse_number,]
  # Get ready for time series matrix: each row represent each warehouse, each column represnts one time spot
  id_x <- unique(x$NEWID)
  x <- split(x$sum, x$NEWID) %>% unlist()
  x <- matrix(x,nrow = length(id_x))
  # calcaute the time series distance 
  # The choice of window.size means how much the mapping (small adjustment?)
  da = dist(x, method="TSDistances", distance="dtw",window.size=7, diag=TRUE, upper=TRUE)
  da <- as.data.frame(as.matrix(da))
  row.names(da) <- unique(id_x)
  return(da)
}
# find dtw matrix
```

```{r}
# result <- dtw_function(actual_daily,"2021-03-29","2021-07-04",320)
result1 <- dtw_function(efficiency_daily,"2021-01-01","2021-08-01")

# Different cluster method: K-mean cluster, hierarchical cluster
# K-mean cluster
# choose the centers manually
k1 <- kmeans(result1, centers = 3, nstart = 25)
fviz_cluster(k1, data = result1)
```

```{r}
# function to compute total within-cluster sum of square 
wss <- function(k) {
  kmeans(result, k, nstart = 25)$tot.withinss
}
# Compute and plot wss for k = 1 to k = 5
k.values <- 1:5
# extract wss for 2-15 clusters
wss_values <- map_dbl(k.values, wss)
# plot to find the best cluster number 
plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
#https://www.datanovia.com/en/lessons/k-means-clustering-in-r-algorith-and-practical-examples/
```

```{r}
# delete cluster3
efficiency_daily_delete_c3 <- subset(efficiency_daily,NEWID!="18"&NEWID!="39"&NEWID!="182"&NEWID!="247"&NEWID!="296")

result2 <- dtw_function(efficiency_daily_delete_c3,"2021-01-01","2021-07-31")

# cluster again
k2 <- kmeans(result2, centers = 3, nstart = 25)
fviz_cluster(k2, data = result2)
```

```{r}
############### hierarchical cluster
# plot(hclust(result_b)) ## doesn't work for dataframe
hclustfunc <- function(x) hclust(x, method="complete")
distfunc <- function(x) as.dist((1-cor(t(x)))/2)
d <- distfunc(result)
fit <- hclustfunc(d)
plot(fit)
# No need for changing k
fit <- cmdscale(result,eig=TRUE, k=2)
x <- fit$points[,1]
y <- fit$points[,2]
# Project the distance matrix to 2D plot. 
plot(x, y, xlab="Coordinate 1", ylab="Coordinate 2",
  main="Metric MDS")
```



```{r}
### warehouse 48, 1,2 
#### Playground and plot stuffs, 
actual_daily$date <-as.Date(actual_daily$date)

b <- actual_daily %>% 
  filter(NEWID==48) %>%
  filter(date>= "2021-03-29" & date <="2021-07-04")

c <- actual_daily %>% 
  filter(NEWID==226) %>%
  filter(date>= "2021-03-29" & date <="2021-07-04")

e <- actual_daily %>% 
  filter(NEWID==1) %>%
  filter(date>= "2021-03-29" & date <="2021-07-04")


hh <- as.data.frame(cbind(c(1:98),c$sum,b$sum,e$sum))
ggplot(hh, aes(x=V1,y = V2)) +
    geom_line(aes(x = V1, y = V2), color = 'black') +
    geom_line(aes(x = V1, y = V3), color = 'red') +
    geom_line(aes(x = V1, y = V4), color = 'yellow')


b <- actual_daily %>% filter(!NEWID %in% c(48,1,2,47,46,45))
c <- actual_daily %>% filter(NEWID %in% c(1:20))
```


























